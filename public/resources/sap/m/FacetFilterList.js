/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP AG or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
jQuery.sap.declare("sap.m.FacetFilterList");jQuery.sap.require("sap.m.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.m.FacetFilterList",{metadata:{publicMethods:["getSelectedItems","removeSelections"],library:"sap.m",properties:{"title":{type:"string",group:"Appearance",defaultValue:null},"allCount":{type:"int",group:"Misc",defaultValue:null},"active":{type:"boolean",group:"Behavior",defaultValue:true},"key":{type:"string",group:"Identification",defaultValue:null},"multiSelect":{type:"boolean",group:"Behavior",defaultValue:true},"sequence":{type:"int",group:"Behavior",defaultValue:-1},"growing":{type:"boolean",group:"Behavior",defaultValue:true},"growingThreshold":{type:"int",group:"Misc",defaultValue:20},"growingTriggerText":{type:"string",group:"Misc",defaultValue:null}},aggregations:{"items":{type:"sap.m.FacetFilterItem",multiple:true,singularName:"item"}},events:{"listOpen":{},"listClose":{}}}});sap.m.FacetFilterList.M_EVENTS={'listOpen':'listOpen','listClose':'listClose'};jQuery.sap.require("sap.m.List");jQuery.sap.require("sap.m.StandardListItem");jQuery.sap.require("sap.m.Button");jQuery.sap.require("sap.m.ButtonType");jQuery.sap.require("sap.ui.model.Filter");jQuery.sap.require("sap.ui.model.FilterOperator");
sap.m.FacetFilterList.prototype.init=function(){var t=this;this._viewList=null;this.bUseExtendedChangeDetection=true;this._oODataItemCache={};this._bundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");var h=new sap.m.Bar(this.getId()+"-headerbar");this._checkboxBar=null;this._popoverOpened=false;this._popover=new sap.m.Popover(this.getId()+"-popup",{placement:sap.m.PlacementType.Bottom,beforeOpen:function(e){this.getCustomHeader().addContentMiddle(t._getSearchField());if(t.getMultiSelect()){var s=this.getSubHeader();if(!s){this.setSubHeader(t._getSelectAllCheckboxBar())}}this.addContent(t._createFilterItemsList());t._showPopoverOkButton();this.setInitialFocus(t._getSearchField())},afterClose:function(e){if(sap.ui.Device.browser.internet_explorer&&sap.ui.Device.browser.version<10){setTimeout(function(){t._fireListCloseEvent();t._displayRemoveIcon(false);t._popover.removeContent(t._viewList);t._destroyListControls();t._popoverOpened=false},100)}else{t._fireListCloseEvent();t._displayRemoveIcon(false);this.removeContent(t._viewList);t._destroyListControls();t._popoverOpened=false}},horizontalScrolling:false,customHeader:h});this._popover.addStyleClass("sapMFFPop")};
sap.m.FacetFilterList.prototype._handleSelectionChangeEvent=function(e){var l=e.getParameters().listItem;var s=e.getParameters().selected;var f=this.getItems();var S=!this.getMultiSelect();var a=l.getBindingContext(this._modelName).getPath();if(!l.getBindingInfo("selected")){var F=false;for(var i=0;i<f.length;i++){if(!F&&f[i].getBindingContext(this._modelName).getPath()===a){f[i].setSelected(s);F=true;if(!S){break}}else if(S){f[i].setProperty("selected",false,true)}}}else if(S&&this._getViewList().getItems().length<f.length){for(var i=0;i<f.length;i++){if(f[i].getBindingContext(this._modelName).getPath()!==a){if(f[i].getSelected()){f[i].setProperty("selected",false,true);break}}}}this._setCBSelectAll()};
sap.m.FacetFilterList.prototype._handleSearchEvent=function(e){var s=e.getParameters()["query"];if(s===undefined){s=e.getParameters()["newValue"]}this._searchValue=s;this._executeSearch(s)};
sap.m.FacetFilterList.prototype._executeSearch=function(s){var b=this._getViewList().getBinding("items");if(b){var p=this._getViewList().getBindingInfo("items").template.getBindingInfo("title").parts[0].path;if(p){var u=new sap.ui.model.Filter(p,sap.ui.model.FilterOperator.Contains,s);var f=new sap.ui.model.Filter([u],true);b.filter(f,sap.ui.model.FilterType.Control)}}};
sap.m.FacetFilterList.prototype._showPopoverOkButton=function(){var t=this;if(this.getParent()){if(this.getParent().getShowPopoverOKButton()){if(!this._okFilterButton){this._okFilterButton=new sap.m.Button(this.getId()+"-ok",{text:t._bundle.getText("FACETFILTER_ACCEPT"),width:"100%",press:function(){t._popover.close()}});this._popover.setFooter(this._okFilterButton)}}else{var b=this._popover.getFooter();if(b){this._popover.setFooter(null);b.destroy();delete this._okFilterButton}}}};
sap.m.FacetFilterList.prototype._copySelectionsToList=function(){var t=this;var l=this._getViewList().getItems();var f=this.getItems();var m=this._modelName;var a=0;for(var j=0;j<f.length;j++){var b=f[j];if(!b.getBindingInfo("selected")){if(b.getBindingContext(m)&&b.getBindingContext(m).getPath()){var p=b.getBindingContext(m).getPath();t._restoreItemFromODataItemCache(b);for(var i=a;i<l.length;i++){if(l[i].getBindingContext(m)&&l[i].getBindingContext(m).getPath()===p){l[i].setSelected(b.getSelected());a=i;break}}}}}};
sap.m.FacetFilterList.prototype._fireListCloseEvent=function(){var s=this.getSelectedItems();if(this.getParent().getType()===sap.m.FacetFilterType.Simple){this._getFacetButton().setText(this._getSelectionText())}var a=s.length===this.getItems().length||s.length===0;this.fireListClose({selectedItems:s,allSelected:a})};
sap.m.FacetFilterList.prototype._getFacetButton=function(){if(!this._button){var t=this;this._button=new sap.m.Button({type:sap.m.ButtonType.Transparent,press:function(e){if(!t._popover.isOpen()){t._popoverOpened=true;t.fireListOpen({});t._popover.openBy(t._getFacetButton());t._displayRemoveIcon(true)}},id:this.getId()+"-button"});this._button.setParent(this.getParent())}return this._button};
sap.m.FacetFilterList.prototype._getFacetRemoveIcon=function(){var t=this;if(!this._facetRemoveIcon){this._facetRemoveIcon=new sap.ui.core.Icon(this.getId()+"-remove",{src:sap.ui.core.IconPool.getIconURI("sys-cancel"),press:function(e){t.removeSelections();t.setActive(false)}});this._facetRemoveIcon.addStyleClass("sapMFFLRemoveIcon");this._facetRemoveIcon.setParent(this.getParent())}this._displayRemoveIcon(false);return this._facetRemoveIcon};
sap.m.FacetFilterList.prototype.exit=function(){if(this._button){this._button.destroy();this._button=undefined}if(this._facetRemoveIcon){this._facetRemoveIcon.destroy();this._facetRemoveIcon=undefined}if(this._popover){this._popover.destroy();this._popover=undefined}this._clearODataItemCache();this._destroyListControls()};
sap.m.FacetFilterList.prototype.getSelectedItems=function(){var s=[];var l=this.getItems();if(l.length>0){for(var i=0;i<l.length;i++){if(l[i].getSelected()){s.push(l[i])}}}this._getItemsFromCache(s);return s};
sap.m.FacetFilterList.prototype.removeSelections=function(){var f=this.getItems();jQuery.each(f,function(i,v){v.setProperty("selected",false,true)});this._clearODataItemCache();return this};
sap.m.FacetFilterList.prototype._getSelectionText=function(){var t="";var s=this.getSelectedItems();if(s.length>0&&s.length<this.getItems().length){if(s.length===1){t=this._bundle.getText("FACETFILTER_ITEM_SELECTION",[this.getTitle(),s[0].getText()])}else{t=this._bundle.getText("FACETFILTER_ITEM_SELECTION",[this.getTitle(),s.length])}}else{t=this._bundle.getText("FACETFILTER_ALL_SELECTED",[this.getTitle()])}return t};
sap.m.FacetFilterList.prototype.unbindAggregation=function(n,s){if(n==="items"&&this._getViewList()){this._getViewList().unbindAggregation(n,s)}sap.ui.base.ManagedObject.prototype.unbindAggregation.apply(this,arguments)};
sap.m.FacetFilterList.prototype.bindAggregation=function(n,b){if(n==="items"){var p,t,s,f,P;var S=new sap.m.StandardListItem();var i=typeof b=="string";if(i){p=arguments[1];t=arguments[2];s=arguments[3];f=arguments[4]}else{p=b.path;t=b.template;s=b.sorter;f=b.filters;P=b.parameters}var l={path:p,template:S,sorter:s,filters:f,parameters:P};var T=t.getBindingInfo("text");if(T){S.bindProperty("title",T)}if(t.getBindingInfo("count")){S.bindProperty("counter",t.getBindingInfo("count"))}if(t.getBindingInfo("selected")){S.bindProperty("selected",t.getBindingInfo("selected"))}sap.ui.base.ManagedObject.prototype.bindAggregation.apply(this,arguments);l.model=this._modelName=this.getBindingInfo(n).model;this._oListBindingInfo=l;if(this._viewList){this._initializeViewList()}}else{sap.ui.base.ManagedObject.prototype.bindAggregation.apply(this,arguments)}};
sap.m.FacetFilterList.prototype.addItem=function(i){this._restoreItemFromODataItemCache(i);this.addAggregation("items",i,true);return this};
sap.m.FacetFilterList.prototype.destroyItems=function(){var s=this._popoverOpened;return this.destroyAggregation("items",s)};
sap.m.FacetFilterList.prototype._setCBSelectAll=function(){if(this.getMultiSelect()){var s=this.getSelectedItems().length;this._getSelectAllCheckbox().setSelected(s===0&&this.getActive())}};
sap.m.FacetFilterList.prototype._isModelTypeOData=function(){var u=sap.ui.model,b=this.getBindingInfo("items"),B=b&&b.binding,o=u&&u.odata&&u.odata.ODataListBinding;return o&&B instanceof o};
sap.m.FacetFilterList.prototype._clearODataItemCache=function(){if(this._oODataItemCache){jQuery.each(this._oODataItemCache,function(k,v){v.destroy()});this._oODataItemCache={}}return this};
sap.m.FacetFilterList.prototype._isODataItemCacheNeeded=function(i){return this._isModelTypeOData()&&!i.getBindingInfo("selected")};
sap.m.FacetFilterList.prototype._addItemToODataItemCache=function(i){if(this._isODataItemCacheNeeded(i)){if(!this.getMultiSelect()){this._clearODataItemCache()}var p=i.getBindingContext(this._modelName).getPath();this._oODataItemCache[p]=new sap.m.FacetFilterItem({text:i.getText(),key:i.getKey()})}};
sap.m.FacetFilterList.prototype._removeItemFromODataItemCache=function(i){if(this._isODataItemCacheNeeded(i)){var p=i.getBindingContext(this._modelName).getPath();var v=this._oODataItemCache[p];if(v){v.destroy()}delete this._oODataItemCache[p]}};
sap.m.FacetFilterList.prototype._restoreItemFromODataItemCache=function(i){if(this._isODataItemCacheNeeded(i)){var p=i.getBindingContext(this._modelName).getPath();i.setSelected(!!this._oODataItemCache[p])}};
sap.m.FacetFilterList.prototype._getItemsFromCache=function(s){if(this._isModelTypeOData()){var c=this._oODataItemCache;var e={};var S=s.length;for(var i=0;i<S;i++){e[s[i].getBindingContext(this._modelName).getPath()]=true}jQuery.each(c,function(a,v){if(!e[a]){s.push(v)}})}};
sap.m.FacetFilterList.prototype._getViewList=function(){return this._viewList};
sap.m.FacetFilterList.prototype._createFilterItemsList=function(){var t=this;this._viewList=new sap.m.List(this.getId()+"-filterlist",{growing:this.getGrowing(),growingThreshold:this.getGrowingThreshold(),growingTriggerText:this.getGrowingTriggerText(),showNoData:true,scrollToLoad:false,rememberSelections:false,mode:this.getMultiSelect()?sap.m.ListMode.MultiSelect:sap.m.ListMode.SingleSelectMaster,selectionChange:function(e){t._handleSelectionChangeEvent(e)},includeItemInSelection:true});var u=this._viewList.updateItems;this._viewList.updateItems=function(){u.apply(t._viewList,arguments);if(!t.getGrowing()){t._copySelectionsToList();t._setCBSelectAll()}};var g=this._viewList._oGrowingDelegate;if(g&&g.updateItems){var U=g.updateItems;g.updateItems=function(){U.apply(g,arguments);t._copySelectionsToList();t._setCBSelectAll()}}this._initializeViewList();var s=this._searchField.getValue();if(s){this._executeSearch(s)}return this._viewList};
sap.m.FacetFilterList.prototype._destroyListControls=function(){if(this._viewList){this._viewList.destroy();delete this._viewList}if(this._searchField){var p=this._searchField.getParent();if(p){p.removeContentMiddle(this._searchField)}this._searchField.destroy();delete this._searchField}if(this._checkboxBar){this._checkboxBar.destroy();delete this._checkboxBar}};
sap.m.FacetFilterList.prototype._getSearchField=function(){if(!this._searchField){var t=this;this._searchField=new sap.m.SearchField(this.getId()+"-searchField",{value:this._searchValue,width:"100%",search:function(e){t._handleSearchEvent(e)}})}this._searchField.detachLiveChange(this._handleSearchEvent,this);if(this.getParent()&&this.getParent().getLiveSearch()){this._searchField.attachLiveChange(this._handleSearchEvent,this)}return this._searchField};
sap.m.FacetFilterList.prototype._getSelectAllCheckbox=function(){return this._checkboxBar.getContentLeft()[0]};
sap.m.FacetFilterList.prototype._getSelectAllCheckboxBar=function(){if(!this._checkboxBar){var t=this;this._checkboxBar=new sap.m.Bar();this._checkboxBar.ontap=function(e){if(e.srcControl.getId()===this.getId()){var s=t._getSelectAllCheckbox().getSelected();if(s){t._getSelectAllCheckbox().setSelected(t.getActive())}else{t._getViewList().removeSelections(true);t.removeSelections();if(t.getActive()){t._setCBSelectAll()}}}};var c=new sap.m.CheckBox(this.getId()+"-selectAll",{text:this._bundle.getText("FACETFILTER_CHECKBOX_ALL"),select:function(e){if(!e.getParameter("selected")){this.setSelected(t.getActive())}else{t._getViewList().removeSelections(true);t.removeSelections();if(t.getActive()){t._setCBSelectAll()}}}});this._checkboxBar.addContentLeft(c)}return this._checkboxBar};
sap.m.FacetFilterList.prototype._displayRemoveIcon=function(d){if(this._facetRemoveIcon){if(d){this._facetRemoveIcon.removeStyleClass("sapMFFLHiddenRemoveIcon");this._facetRemoveIcon.addStyleClass("sapMFFLVisibleRemoveIcon")}else{this._facetRemoveIcon.removeStyleClass("sapMFFLVisibleRemoveIcon");this._facetRemoveIcon.addStyleClass("sapMFFLHiddenRemoveIcon")}}};
sap.m.FacetFilterList.prototype._initializeViewList=function(){if(this.getBindingContext(this._modelName)){this._viewList.setBindingContext(this.getBindingContext(this._modelName),this._modelName);this._viewList.setModel(this.getBindingContext(this._modelName).getModel(),this._modelName)}else{this._viewList.setModel(this.getModel(this._modelName),this._modelName)}if(this._oListBindingInfo){this._viewList.bindAggregation("items",this._oListBindingInfo)}};
