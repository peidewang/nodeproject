/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP AG or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
jQuery.sap.declare("sap.m.FacetFilter");jQuery.sap.require("sap.m.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.m.FacetFilter",{metadata:{publicMethods:["openFilterDialog"],library:"sap.m",properties:{"type":{type:"sap.m.FacetFilterType",group:"Appearance",defaultValue:sap.m.FacetFilterType.Simple},"visible":{type:"boolean",group:"Appearance",defaultValue:true},"showPersonalization":{type:"boolean",group:"Behavior",defaultValue:false},"showSummaryBar":{type:"boolean",group:"Behavior",defaultValue:false},"showReset":{type:"boolean",group:"Behavior",defaultValue:true},"liveSearch":{type:"boolean",group:"Behavior",defaultValue:true},"showPopoverOKButton":{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"lists",aggregations:{"lists":{type:"sap.m.FacetFilterList",multiple:true,singularName:"list"}},events:{"reset":{}}}});sap.m.FacetFilter.M_EVENTS={'reset':'reset'};jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.ui.core.Icon");sap.m.FacetFilter.SCROLL_STEP=264;
sap.m.FacetFilter.prototype.init=function(){var t=this;this._lastScrolling=false;this._bPreviousScrollForward=false;this._bPreviousScrollBack=false;this._bNavigationInProgress=false;this._bOkPressedDuringNavigate=false;this._bRtl=sap.ui.getCore().getConfiguration().getRTL();if(jQuery.sap.touchEventMode==="ON"&&!jQuery.device.is.phone){this._enableTouchSupport()}this._bundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._resetIcon=new sap.ui.core.Icon(this.getId()+"-rb",{src:sap.ui.core.IconPool.getIconURI("undo"),press:function(e){t.fireReset();var F=t.getLists();for(var i=0;i<F.length;i++){F[i]._getFacetButton().setText(F[i]._getSelectionText())}}});this._facetAddIcon=new sap.ui.core.Icon(this.getId()+"-add",{src:sap.ui.core.IconPool.getIconURI("add-filter"),press:function(e){t.openFilterDialog()}});this._facetAddIcon.addStyleClass("sapMFFAddIcon");var s=this._getType()===sap.m.FacetFilterType.Light?true:false;this._summaryBarText=new sap.m.Text(this.getId()+"-summaryBarTxt",{maxLines:1});this._summaryBar=new sap.m.Toolbar(this.getId()+"-summaryBar",{content:[this._summaryBarText],active:s,design:sap.m.ToolbarDesign.Info,press:function(e){t.openFilterDialog()}});var S=new sap.m.StandardListItem({title:"{text}",selected:"{selected}",counter:"{count}",customData:[new sap.ui.core.CustomData({key:"index",value:"{index}"})]});this._facetList=new sap.m.List(this.getId()+"-facetlist",{mode:sap.m.ListMode.SingleSelectMaster,items:{path:"/items",template:S},selectionChange:function(e){var c=e.getParameter("listItem").getCustomData();for(var i=0;i<c.length;i++){if(c[i].getKey()==="index"){t._currentFacetIndex=c[i].getValue();break}}t._getSelectedFacetFilterList().fireListOpen({});t._navcon.to(t.getId()+"-item")}});var f=new sap.m.SearchField(this.getId()+"-facetsSearchField",{width:"100%",liveChange:function(e){var b=t._facetList.getBinding("items");if(b){var a=new sap.ui.model.Filter("text",sap.ui.model.FilterOperator.Contains,e.getParameters()["newValue"]);b.filter([a])}}});this._navcon=new sap.m.NavContainer(this.getId()+"-navcon",{navigate:function(e){t._bNavigationInProgress=true;var T=e.getParameters()["to"];if(T.getId()===t.getId()+"-item"){var F=t._getSelectedFacetFilterList();T.getSubHeader().addContentMiddle(F._getSearchField());if(F.getMultiSelect()){T.addContent(F._getSelectAllCheckboxBar())}T.setTitle(F.getTitle());T.addContent(F._createFilterItemsList())}},afterNavigate:function(e){var F=e.getParameters()["from"];if(F.getId()===t.getId()+"-item"){var o=t._getSelectedFacetFilterList();var c=o._getSelectAllCheckboxBar();if(o.getMultiSelect()){F.removeContent(c)}}t._bNavigationInProgress=false;if(t._bOkPressedDuringNavigate){t._bOkPressedDuringNavigate=false;t._pressDialogOk()}},pages:[new sap.m.Page(this.getId()+"-filter",{enableScrolling:true,title:this._bundle.getText("FACETFILTER_TITLE"),subHeader:new sap.m.Bar({contentMiddle:f}),content:[this._facetList]}),new sap.m.Page(this.getId()+"-item",{showNavButton:true,enableScrolling:true,subHeader:new sap.m.Bar(),navButtonPress:function(e){t._applyDialogSelection();t._facetList.getSelectedItem().setCounter(t._getSelectedFacetFilterList().getAllCount());t._facetList.setSelectedItem(t._facetList.getSelectedItem(),false);t._navcon.back(t.getId()+"-filter");t._getSelectedFacetFilterList()._destroyListControls()}})]});this._dialog=new sap.m.Dialog(this.getId()+"-dialog",{showHeader:false,content:this._navcon,stretch:jQuery.device.is.phone?true:false,afterClose:function(){t._summaryBar.getContent()[0].setText(t._getSummaryText())},beginButton:new sap.m.Button(this.getId()+"-dialog-okbtn",{text:this._bundle.getText("FACETFILTER_ACCEPT"),press:function(){t._pressDialogOk()}}),contentHeight:"500px"})};
sap.m.FacetFilter.prototype.onBeforeRendering=function(){sap.ui.getCore().detachIntervalTimer(this._checkOverflow,this)};
sap.m.FacetFilter.prototype.onAfterRendering=function(){if(!jQuery.device.is.phone){sap.ui.getCore().attachIntervalTimer(this._checkOverflow,this)}};
sap.m.FacetFilter.prototype.openFilterDialog=function(){this._aFacetFilterLists=[];for(var i=0;i<this.getLists().length;i++){var l=this.getLists()[i];this._aFacetFilterLists.push({text:l.getTitle(),count:l.getAllCount(),index:i})}var j=new sap.ui.model.json.JSONModel({items:this._aFacetFilterLists});this._facetList.setModel(j);this._dialog.open();this._navcon.backToTop()};
sap.m.FacetFilter.prototype._applyDialogSelection=function(){if(this._navcon.getCurrentPage().getId()===this.getId()+"-item"){var f=this._getSelectedFacetFilterList();var m=f._modelName;var F=f.getItems();var l=f._getViewList().getItems();var s=false;if(f.getMultiSelect()){s=f._getSelectAllCheckbox().getSelected()}jQuery.each(l,function(a,v){if(!v.getBindingInfo("selected")){for(var i=a;i<F.length;i++){if(v.getBindingContext(m)&&v.getBindingContext(m).getPath()){var p=v.getBindingContext(m).getPath();if(F[i].getBindingContext(m)&&F[i].getBindingContext(m).getPath()===p){s=s||v.getSelected();F[i].setSelected(v.getSelected());break}}}}});if(!s){for(var i=0;i<F.length;i++){s=F[i].getSelected();if(s){break}}}if(s){f.setActive(true);f._fireListCloseEvent()}}};
sap.m.FacetFilter.prototype._pressDialogOk=function(){if(this._bNavigationInProgress){this._bOkPressedDuringNavigate=true;return}this._applyDialogSelection();this._dialog.close();if(this._navcon.getCurrentPage().getId()===(this.getId()+"-item")){this._getSelectedFacetFilterList()._destroyListControls()}sap.ui.getCore().byId(this.getId()+"-facetsSearchField").setValue()};
sap.m.FacetFilter.prototype.exit=function(){if(this._facetAddIcon){this._facetAddIcon.destroy();this._facetAddIcon=undefined}if(this._resetIcon){this._resetIcon.destroy();this._resetIcon=undefined}if(this._summaryBar){this._summaryBar.destroy();this._summaryBar=undefined}if(this._oArrowLeft){this._oArrowLeft.destroy();this._oArrowLeft=undefined}if(this._oArrowRight){this._oArrowRight.destroy();this._oArrowRight=undefined}if(this._dialog){this._dialog.destroy();this._dialog=undefined}};
sap.m.FacetFilter.prototype._getSummaryText=function(){var C=", ";var S=" ";var f="";var F=true;var l=this.getLists();if(l.length>0){for(var i=0;i<l.length;i++){var o=l[i];if(o.getActive()){var L=o.getSelectedItems();var t="";for(var j=0;j<L.length;j++){t=t+L[j].getText()+C}if(t){t=t.substring(0,t.lastIndexOf(C)).trim();if(F){f=this._bundle.getText("FACETFILTER_INFOBAR_FILTERED_BY",[o.getTitle(),t]);F=false}else{f=f+S+this._bundle.getText("FACETFILTER_INFOBAR_AND")+S+this._bundle.getText("FACETFILTER_INFOBAR_AFTER_AND",[o.getTitle(),t])}}}}}if(!f){f=this._bundle.getText("FACETFILTER_INFOBAR_NO_FILTERS")}return f};
sap.m.FacetFilter.prototype._getScrollingArrow=function(n){var p={src:"sap-icon://navigation-"+n+"-arrow"};var c=["sapMPointer","sapMFFArrowScroll","sapMFFArrowScrollLeft"];var C=["sapMPointer","sapMFFArrowScroll","sapMFFArrowScrollRight"];if(n==="left"){if(!this._oArrowLeft){this._oArrowLeft=sap.m.ImageHelper.getImageControl(this.getId()+"-arrowScrollLeft",this._oArrowLeft,this,p,c)}return this._oArrowLeft}if(n==="right"){if(!this._oArrowRight){this._oArrowRight=sap.m.ImageHelper.getImageControl(this.getId()+"-arrowScrollRight",this._oArrowRight,this,p,C)}return this._oArrowRight}};
sap.m.FacetFilter.prototype._checkOverflow=function(){var b=jQuery.sap.domById(this.getId()+"-head");var $=this.$();var s=false;if(b){if(b.scrollWidth>b.clientWidth){s=true}}$.toggleClass("sapMFFScrolling",s);$.toggleClass("sapMFFNoScrolling",!s);this._lastScrolling=s;if(b){var S=b.scrollLeft;var a=false;var c=false;var r=b.scrollWidth;var d=b.clientWidth;if(Math.abs(r-d)==1){r=d}if(!this._bRtl){if(S>0){a=true}if((r>d)&&(S+d<r)){c=true}}else{var l=jQuery(b);if(l.scrollLeftRTL()>0){c=true}if(l.scrollRightRTL()>0){a=true}}if((c!=this._bPreviousScrollForward)||(a!=this._bPreviousScrollBack)){this._bPreviousScrollForward=c;this._bPreviousScrollBack=a;$.toggleClass("sapMFFNoScrollBack",!a);$.toggleClass("sapMFFNoScrollForward",!c)}}};
sap.m.FacetFilter.prototype.onclick=function(e){var t=e.target.id;if(t){var i=this.getId();e.preventDefault();if(t==i+"-arrowScrollLeft"){this._scroll(-sap.m.FacetFilter.SCROLL_STEP,500)}else if(t==i+"-arrowScrollRight"){this._scroll(sap.m.FacetFilter.SCROLL_STEP,500)}}};
sap.m.FacetFilter.prototype._scroll=function(d,D){var o=jQuery.sap.domById(this.getId()+"-head");var s=o.scrollLeft;if(!!!sap.ui.Device.browser.internet_explorer&&this._bRtl){d=-d}var S=s+d;jQuery(o).stop(true,true).animate({scrollLeft:S},D)};
sap.m.FacetFilter.prototype._getType=function(){if(jQuery.device.is.phone){return sap.m.FacetFilterType.Light}else{return this.getType()}};
sap.m.FacetFilter.prototype._getShowSummaryBar=function(){if(this._getType()===sap.m.FacetFilterType.Light){return true}else{return this.getShowSummaryBar()}};
sap.m.FacetFilter.prototype._enableTouchSupport=function(){var t=this;var T=function(e){e.preventDefault();if(t._iInertiaIntervalId){window.clearInterval(t._iInertiaIntervalId)}t.startScrollX=jQuery.sap.domById(t.getId()+"-head").scrollLeft;t.startTouchX=e.touches[0].pageX;t._bTouchNotMoved=true;t._lastMoveTime=new Date().getTime()};var f=function(e){var d=e.touches[0].pageX-t.startTouchX;var l=jQuery.sap.domById(t.getId()+"-head");var o=l.scrollLeft;var n=t.startScrollX-d;l.scrollLeft=n;t._bTouchNotMoved=false;var b=new Date().getTime()-t._lastMoveTime;t._lastMoveTime=new Date().getTime();if(b>0){t._velocity=(n-o)/b}e.preventDefault()};var a=function(e){if(t._bTouchNotMoved===false){e.preventDefault();var l=jQuery.sap.domById(t.getId()+"-head");var d=50;var b=Math.abs(t._velocity/10);t._iInertiaIntervalId=window.setInterval(function(){t._velocity=t._velocity*0.80;var c=t._velocity*d;l.scrollLeft=l.scrollLeft+c;if(Math.abs(t._velocity)<b){window.clearInterval(t._iInertiaIntervalId);t._iInertiaIntervalId=undefined}},d)}else if(t._bTouchNotMoved===true){t.onclick(e);e.preventDefault()}else{}t._bTouchNotMoved=undefined;t._lastMoveTime=undefined};this.ontouchstart=T;this.ontouchend=a;this.ontouchmove=f};
sap.m.FacetFilter.prototype._getSelectedFacetFilterList=function(){return this.getLists()[this._currentFacetIndex]};
